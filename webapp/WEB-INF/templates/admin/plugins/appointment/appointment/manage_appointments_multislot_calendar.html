<@row>
    <@columns>
        <@appointmentTabs tab="calendar" form=form />
    </@columns>
</@row>

<@modal id='commentModal'>
    <@modalHeader modalTitle='#i18n{appointment.create_comment.pageTitle}' />
	<@modalBody>
		<@getCommentForm "comment" "startingValidityDate" "endingValidityDate" "doAddComment" id_form />
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<@modal id='modify-comment'>
	<@modalHeader modalTitle='#i18n{appointment.modify_comment.pageTitle}' />
	<@modalBody>
		<@getCommentForm "comment" "modifyStartingValidityDate" "modifyEndingValidityDate" "doModifyComment" id_form />
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<@modal id='addbook_modal' params='aria-labelledby="qModalLabel"'>
    <@modalHeader id='qModalLabel' modalTitle='#i18n{appointment.appointmentApp.defaultTitle}' />
    <@modalBody>
		<p id="loader" class="text-center">
			#i18n{appointment.createAppointmentForm.labelMaxPeoplePerAppointment}
		</p>
		<@tform id='form-validate' action='jsp/admin/plugins/appointment/ManageAppointments.jsp' params='enctype="multipart/form-data"'>
			<@input type='hidden' name='view' value='createAppointment' />
            <@input type='hidden' name='id_form' value='${id_form}' />
            <@input type='hidden' id='starting_date_time' name='starting_date_time' value='' />
            <@formGroup class='${formGroupClass!}' labelFor='starting_date' labelKey='#i18n{appointment.dateAppointment.title}' helpKey='${formGroupHelpKey!}' mandatory=true>
                <@input type='text' name='starting_date_time_span' id='starting_date_time_span' disabled=true />
            </@formGroup>
            <@formGroup class='${formGroupClass!}' labelFor='nbPlacesToTake' labelKey='#i18n{appointment.createAppointmentForm.labelMaxPeoplePerAppointment}' helpKey='${formGroupHelpKey!}' mandatory=true>
                <@input type='number' name='nbPlacesToTake' id='nbPlacesToTake' value='1' maxlength=3 params='onkeypress="return validateQty(event);"' min=1 max=10 />
            </@formGroup>
			<@formGroup>
				<@button type='submit' name='save' id='save' buttonIcon='check' title='#i18n{appointment.displayAppointmentForm.labelValidate}' />
			</@formGroup>	
		</@tform>
	</@modalBody>
</@modal>
<script type="text/javascript">
/* ********************************************************* */
/*  TODO : Add style def to model
    Possible values: dotted, bordered , bg-full,  bg-grad    
*/
<#assign typeClass=''>
<#assign titleSlot=true >
var bgOpenColor = '#fff;'
var bgClosedColor = '#bebebe;'
/* ********************************************************* */
var slotDuration = '${min_duration}';
var minTime = '${min_time}';
var maxTime = '${max_time}';
var dow = [<#if dow??><#list dow as day>'${day}',</#list></#if>];
var startingDateOfDisplay = '${starting_date_of_display}';
var endingDateOfDisplay = '${ending_date_of_display}';
var strStartingDateOfDisplay = '${str_starting_date_of_display}';
var strEndingDateOfDisplay = '${str_ending_date_of_display}';
var eventUrl = 'jsp/admin/plugins/appointment/ManageAppointments.jsp?view=';
var idForm = '${id_form}';
var columnFormat = 'dddd DD/MM/YYYY';
var events = [

<#if events??>
    <#list events as event>
        <#assign nbAppointments = event.nbPlacesTaken>
        <#assign maxCap = event.maxCapacity?number>
        <#if maxCap = 0><#assign maxCap = 1></#if>
        <#assign nbFull = nbAppointments / maxCap * 100 >
        <#assign eventTitle='${nbAppointments} / ${maxCap}'>
        <#assign strEventClass><#if event.isOpen & !event.isPassed & (nbAppointments > event.maxCapacity)>overbooked ${typeClass}<#elseif event.isOpen & !event.isPassed & (event.nbRemainingPlaces > 0) & (event.nbPotentialRemainingPlaces = 0)>filled ${typeClass}<#elseif event.isOpen & !event.isPassed & (event.nbRemainingPlaces = 0)>filled ${typeClass}</#if></#assign>
        <#assign strCustomColor><#if event.isOpen & !event.isPassed & (nbAppointments > event.maxCapacity)>rgba(255,165,0,1)<#elseif event.isOpen & !event.isPassed & (event.nbRemainingPlaces > 0) & (event.nbPotentialRemainingPlaces = 0)>rgba(255,0,0,1)<#elseif event.isOpen & !event.isPassed & (event.nbRemainingPlaces = 0)>rgba(255,0,0,1)<#else>rgba(222,222,222,1)</#if></#assign>
        {
            "title" :   <#if modifDateAppointment>"<a href=" + eventUrl + "viewChangeDateAppointment&id_form=${event.idForm}&id_slot=${event.idSlot}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}&is_open=${event.isOpen?c}&is_specific=${event.isSpecific?c}&max_capacity=${event.maxCapacity}>${nbAppointments} / ${event.maxCapacity}</a>"
                        <#elseif event.isOpen & !event.isPassed & overbookingAllowed && (event.nbRemainingPlaces = event.nbPotentialRemainingPlaces)>
                        "<a href=" + eventUrl + "manageAppointments&id_form=${event.idForm}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}>${nbAppointments} / ${event.maxCapacity}</a>"
                        + "&nbsp;"
                        + "<a href=\"modal\" data-toggle=\"modal\" data-starting_date_time=\"${event.startingDateTime}\" title=\"Add this item\" class=\"open-AddBookDialog\"><span class=\"badge badge-primary\"><i class=\"fa fa-plus\"></i></span></a>"
                        <#elseif event.isOpen & !event.isPassed & (event.nbRemainingPlaces > 0) & (event.nbRemainingPlaces = event.nbPotentialRemainingPlaces)>
                        "<a href=" + eventUrl + "manageAppointments&id_form=${event.idForm}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}>${nbAppointments} / ${event.maxCapacity}</a>"
                        + "&nbsp;"
                        + "<a href=\"modal\" data-toggle=\"modal\" data-starting_date_time=\"${event.startingDateTime}\" title=\"#i18n{appointment.appointmentApp.defaultTitle}\" class=\"open-AddBookDialog\"><span class=\"badge badge-primary\"><i class=\"fa fa-plus\"></i></span></a>"
                        <#elseif event.isOpen & (event.nbRemainingPlaces = 0)>
                        "<a href=" + eventUrl + "manageAppointments&id_form=${event.idForm}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}>${nbAppointments} / ${event.maxCapacity}</a>"
                        <#elseif event.isOpen & (event.nbRemainingPlaces > 0) & (event.nbPotentialRemainingPlaces = 0)>'#i18n{appointment.manageCalendarSlots.labelEditFull}'
                        <#elseif event.isOpen & !event.isPassed & (event.nbRemainingPlaces > 0) & (event.nbPotentialRemainingPlaces > 0) & (event.nbRemainingPlaces > event.nbPotentialRemainingPlaces)>
                        "<a href=" + eventUrl + "manageAppointments&id_form=${event.idForm}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}>${nbAppointments} / ${event.maxCapacity}</a>"
                        + "&nbsp;"
                        + "#i18n{appointment.manageCalendarSlots.labelEdit}"
                        + "&nbsp;"
                        + "<a href=\"modal\" data-toggle=\"modal\" data-starting_date_time=\"${event.startingDateTime}\" title=\"#i18n{appointment.appointmentApp.defaultTitle}\" class=\"open-AddBookDialog\"><span class=\"badge badge-primary\"><i class=\"fa fa-plus\"></i></span></a>"
                        <#elseif event.isOpen>
                        "<a href=" + eventUrl + "manageAppointments&id_form=${event.idForm}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}>${nbAppointments} / ${event.maxCapacity}</a>"
                        <#elseif !event.isOpen & ((event.maxCapacity - event.nbRemainingPlaces) > 0)>"<a href=" + eventUrl + "manageAppointments&id_form=${event.idForm}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}>${nbAppointments} / ${event.maxCapacity}</a>"
                        <#else>"<a href=" + eventUrl + "manageAppointments&id_form=${event.idForm}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}></a>"</#if>,
            "start" :   "${event.startingDateTime}",
            "end" :     "${event.endingDateTime}",
            "id" :      "${event.idSlot}",
            "url" :     eventUrl + "manageAppointments&id_form=${event.idForm}&id_slot=${event.idSlot}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}&is_open=${event.isOpen?c}&is_specific=${event.isSpecific?c}&max_capacity=${event.maxCapacity}&modif_date=${modifDateAppointment?c}",                                                      
            "textColor" :   <#if event.isOpen & !event.isPassed & (nbAppointments > maxCap)>'#000'<#else>'#2c2c2d'</#if>,
            "customClass" : '${strEventClass!}',
            "customStyle" : <#if event.isOpen & !event.isPassed>'linear-gradient( 90deg, ${strCustomColor} 0%, ${strCustomColor} ${nbFull?floor}%, rgba(255,255,255,1) ${nbFull?floor}% )',<#else>'',</#if>
            "backgroundColor": <#if event.isOpen & !event.isPassed & (nbAppointments > maxCap)>bgOpenColor
                                <#elseif event.isOpen & !event.isPassed & (event.nbRemainingPlaces > 0) & (event.nbRemainingPlaces = event.nbPotentialRemainingPlaces)>bgOpenColor
                                <#elseif event.isOpen & !event.isPassed & (event.nbRemainingPlaces > 0) & (event.nbPotentialRemainingPlaces = 0)>bgOpenColor
                                <#elseif event.isOpen & !event.isPassed & (event.nbRemainingPlaces = 0)>bgOpenColor
                                <#elseif event.isOpen & event.isPassed>bgClosedColor<#else>bgClosedColor</#if>,
            "borderColor" : bgClosedColor,
            "type" : "appointment"
        },
    </#list>
</#if>
<#if comment_events??>
    <#list comment_events as comment_event>
    {
        "title" : "${comment_event.comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '\\"')}",
        "start" : "${comment_event.startingValidityDate}",
        "end" : "${comment_event.calendarAllDaySlotEnd}",
        "validity_end" : "${comment_event.endingValidityDate}",
        "id" : "${comment_event.id}",
        "creator_user" : "${comment_event.creatorUserName!''}",
        "creation_date" : "${comment_event.creationDate?date.xs!''}",
        "type": "comment"
    },
    </#list>
</#if>
];

var defaultDate = '${date_of_display}';
var calendar = $('#calendar');
$( function() {
    calendar.fullCalendar({
        displayEventTime: false,
        buttonText : {
            prev : '#i18n{appointment.appointmentApp.previousWeek}',
            next : '#i18n{appointment.appointmentApp.nextWeek}',
        },
        themeSystem: 'jquery-ui',
        navLinks: true,
        navLinkDayClick: function(date, jsEvent) {
            location.href = eventUrl + 'manageAppointments&id_form=' + idForm + '&starting_date_time=' + date.format() + 'T00:00&ending_date_time=' + date.format() + 'T23:59';
        },
        defaultDate: defaultDate,
        defaultView: 'agendaWeek',
        height: 'auto',
        locale: "${locale}",
        nowIndicator: true,
        editable: false,
        customButtons: {
            datePicker: {
                text: '#i18n{appointment.appointmentCalendar.labelChooseDate}',
                click: function () {
                    var $btnCustom = $('.fc-datePicker-button'); // name of custom  button in the generated code
                    $btnCustom.after('<input type="text" id="hiddenDate" class="datepicker" />');
                    $("#hiddenDate").datepicker({
                        showOn: "button",
                        language: "${locale}",
                        autoclose: true,
                        orientation: "bottom"
                    });
                    var $btnDatepicker = $(".ui-datepicker-trigger"); // name of the generated datepicker UI 
                    //Below are required for manipulating dynamically created datepicker on custom button click
                    $("#hiddenDate").focus().hide();
                    $btnDatepicker.trigger("click"); //dynamically generated button for datepicker when clicked on input textbox
                    $btnDatepicker.hide();
                    $btnDatepicker.remove();
                    $("input.datepicker").not(":first").remove();//dynamically appended every time on custom button click
                    $("#hiddenDate").change(function () {
                        $('#calendar').fullCalendar('gotoDate', moment($("#hiddenDate").val(),'DD-MM-YYYY'));
                    });
                }
            }
        },
        header: {
            left: 'prev',
            center: 'today, datePicker, title',
            right: 'next'
        },
        columnHeaderHtml: function(mom) {
            return mom.format('dddd') + '</br>' + mom.format('LL');
        },
        slotLabelFormat: 'H:mm',
        slotLabelInterval: slotDuration,
        slotDuration: slotDuration,
        allDaySlot: true,
        minTime: minTime,
        maxTime: maxTime,
        businessHours: {
            start: minTime,
            end: maxTime,
            dow: dow
        },
        events: events,
        viewRender: function(view, element) {
            var minDate = moment(startingDateOfDisplay);
            var maxDate = moment(endingDateOfDisplay);
            // Past
            if (minDate >= view.start && minDate <= view.end || view.end <= minDate) {
                $(".fc-prev-button").prop('disabled', true);
                $(".fc-prev-button").addClass('fc-state-disabled');
            } else {
                $(".fc-prev-button").removeClass('fc-state-disabled');
                $(".fc-prev-button").prop('disabled', false); 
            }
            // Future
            if (maxDate >= view.start && maxDate <= view.end || maxDate <= view.start) {
                $(".fc-next-button").prop('disabled', true);
                $(".fc-next-button").addClass('fc-state-disabled');
            } else {
                $(".fc-next-button").removeClass('fc-state-disabled');
                $(".fc-next-button").prop('disabled', false); 
            }
        },
        eventAfterAllRender: function(view) {
            $('.fc-event').css('cursor', 'pointer');
            $('.fc-next-button').attr('class', 'fc-next-button btn btn-primary btn-sm');
            $('.fc-prev-button').attr('class', 'fc-prev-button btn btn-primary btn-sm');
            $('.fc-today-button').attr('class', 'fc-today-button btn btn-primary btn-sm');
            $('.fc-datePicker-button').attr('class', 'fc-datePicker-button btn btn-primary btn-sm');
            $(".open-AddBookDialog").click( function () {
                $('#starting_date_time').val($(this).data('starting_date_time'));
                $('#starting_date_time_span').val($(this).data('starting_date_time'));
                $('#addbook_modal').modal('show');
            });
            $(".fc-view.fc-agendaWeek-view.fc-agenda-view .fc-body .ui-widget-content .fc-day-grid .fc-bg .fc-axis.ui-widget-content").html( '' );
            $('.toggle-modify-comment').click(function(ev) {
                ev.preventDefault();
                var formValues = JSON.parse( $(this).attr( "data-json" ) );
                $("#modify-comment input[name='id_comment']").val( formValues.id_comment );
                tinyMCE.activeEditor.setContent( formValues.comment_text );
                $( "#modify-comment input[name='startingValidityDate']" ).datepicker().datepicker( 'setDate', new Date( formValues.comment_start ) );
                $( "#modify-comment input[name='endingValidityDate']" ).datepicker().datepicker( 'setDate', new Date( formValues.comment_end ) );
                $( "#modify-comment" ).modal('show');
            });
        },
        eventMouseover: function ( event, jsEvent, view) {
            var line='',hours=event.start.format('HH'), minutes = parseInt( event.start.format('mm') );
         
            if( minutes==15 || minutes==45 ){
                minutes = minutes - 15;
                line = 'tr[data-time="' + hours + ':' + minutes + ':00"]';
            } else {
                line = 'tr[data-time="' + event.start.format('HH:mm:ss') + '"]';     
            }
            console.log( line );

            $(line).children('td').addClass('hover')
        },
        eventMouseout: function ( event, jsEvent, view) {
            var line='',hours=event.start.format('HH'), minutes = parseInt( event.start.format('mm') );
         
            if( minutes==15 || minutes==45 ){
                minutes = minutes - 15;
                console.log( minutes );
                line = 'tr[data-time="' + hours + ':' + minutes + ':00"]';
            } else {
                line = 'tr[data-time="' + event.start.format('HH:mm:ss') + '"]';     
            }
            $(line).children('td').removeClass('hover')
        },
        eventRender: function( event, element, view ) {
            var $title = element.find( '.fc-title' );
            $(element).addClass( event.customClass );
            
            if ( event.customStyle !='' ){
                $(element).css( 'background', event.customStyle );
            }
            
            $title.html( $title.text() );
            
            $(element).contextmenu(function() {
                return false;
            });

            var json = {
                "container": "body",
                "placement" : "bottom",
                "html" : true,
                "trigger" : "hover"
            };

            if( event.type == "comment" ){
                if ( event.validity_end == null || event.validity_end == undefined ){
                    labelEventDate='Le ' + event.start.format('ddd DD/MM');
                } else {
                    moment.locale("${locale}");
                    labelEventDate = 'Du ' + event.start.format('ddd DD/MM') + ' au '+ moment(event.validity_end).format('ddd DD/MM');
                }
                json.content = '<p>' + labelEventDate +'<p><hr>'+ event.title + '<hr><p><strong>Par ' + event.creator_user + '</strong> le <time>' + event.creation_date + '</time>' ;
            } else {
                json.content = event.start.format('ddd DD/MM')+"</center>" + "<center><b>" + event.start.format('HH:mm') + "</b> - <b>" + event.end.format('HH:mm')+"</b></center>";
            }

            $(element).popover( json );
            
            if(event.type == "comment" ){
                var fcTitle = element.find('.fc-title p');
                fcTitle.prepend( '[' + event.creator_user + ' | ' + event.creation_date + '] ');
                element.append( "<div class='btn-comments'><a href='' class='toggle-modify-comment' data-json='{\"id_comment\": \"" + event.id + "\", \"comment_text\": \"" + event.title.replace(/"/g,'\\"') + "\", \"comment_start\":\"" + event.start.format('YYYY-MM-DD') + "\", \"comment_end\":\"" + event.validity_end + "\" }' ><i class='fa fa-pencil fa-fw'></i></a><a href='jsp/admin/plugins/appointment/Comments.jsp?action=confirmRemoveComment&id_comment=" + event.id + "' class='closeon text-danger'><i class='fa fa-remove fa-fw'></i></a></div>" );
            }
        },
        
    });

});
</script>
<#include "/admin/util/editor/editor.html" />
<@initEditor />

