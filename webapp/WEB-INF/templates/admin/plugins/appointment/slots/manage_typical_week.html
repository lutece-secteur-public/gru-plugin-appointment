<#include "/admin/plugins/appointment/appointmentform/modify_appointmentform_tabs_planning.html" />
<@commonsAppJS />
<@row>
	<@columns>
		<@messages infos=infos errors=errors />
		<@appointmentTabs tab='typicalWeek' appointmentform=appointmentform>
		
			<@tform type='inline' align='right' action='jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp?view=manageTypicalWeek' id='listOfDates' params='enctype="multipart/form-data"'>
				<@input type='hidden' id='id_form' name='id_form' value='${appointmentform.idForm}' />
				
				<#if listDateOfModification??>
					<@formGroup formStyle='inline' labelFor='id_week_definition' labelKey='#i18n{appointment.modifyAppointmentForm.listDateOfModification}'>
						<@inputGroup>
							<@select id='id_week-definition' name='id_week_definition' size='sm'>
								<#list listDateOfModification as item>
									<#if "${id_week_definition}"="${item.code}">
										<option selected="selected" value="${item.code}">${item.name}</option>
									<#else>
										<option value="${item.code}">${item.name}</option>
									</#if>
								</#list>
							</@select>
							<@inputGroupItem>
								<@button type='submit' name='view_manageTypicalWeek' title='#i18n{appointment.labelDisplay}' hideTitle=['xs'] buttonIcon='check' size='sm' />
								<@button type='submit' name='action_confirmRemoveParameter' title='#i18n{portal.util.labelDelete}' hideTitle=['xs'] buttonIcon='trash' size='sm' color='danger' />
							</@inputGroupItem>
						</@inputGroup>
					</@formGroup>
				</#if>
			<#if !error_modification??>
				<#assign appointmentTypicalWeekAdvancedIcon = 'plus' />
			<#else>
				<#assign appointmentTypicalWeekAdvancedIcon = 'minus' />
			</#if>
			<@button style='card-control collapse' buttonTargetId='#appointment_search' buttonIcon='${appointmentTypicalWeekAdvancedIcon}' size='sm' title='#i18n{appointment.typicalWeek.buttonLabelCreate}' />
			</@tform>
			<div style="clear:both;"></div>

				
			<@tform action='jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp' params='enctype="multipart/form-data"' id='appointment_search'>
				<@input type='hidden' id='id_form' name='id_form' value='${appointmentform.idForm}' />
				<@input type='hidden' id='bo_overbooking' name='bo_overbooking' value='${appointmentform.boOverbooking?then("true", "false")}'/> 
				<@input type='hidden' id='is_multislot_appointment' name='is_multislot_appointment' value='${appointmentform.isMultislotAppointment?then("true", "false")}'/>
				
				<@fieldSet legend='#i18n{appointment.modifyAppointmentForm.titleStructuralsParameters}'>
					<@formGroup labelFor='time_start' labelKey='#i18n{appointment.createAppointmentForm.labelTimeStart}' helpKey='#i18n{appointment.createAppointmentForm.labelTimeStart.help}' mandatory=true>
						<@inputGroup>
							<@inputGroupItem type='text'>
								<@icon style='clock-o' />
							</@inputGroupItem>
							<@input type='text' name='time_start' id='time_start' value=appointmentform.timeStart!'' />
						</@inputGroup>
					</@formGroup>
					<@formGroup labelFor='time_end' labelKey='#i18n{appointment.createAppointmentForm.labelTimeEnd}' helpKey='#i18n{appointment.createAppointmentForm.labelTimeEnd.help}' mandatory=true>
						<@inputGroup>
							<@inputGroupItem type='text'>
							  <@icon style='clock-o' />
							</@inputGroupItem>
							<@input type='text' name='time_end' id='time_end' value=appointmentform.timeEnd!'' />
						</@inputGroup>
					</@formGroup>
					<@formGroup labelFor='duration_appointments' labelKey='#i18n{appointment.createAppointmentForm.labelDurationAppointments}' helpKey='#i18n{appointment.createAppointmentForm.labelDurationAppointments.help}' mandatory=true>
						<@input type='text' name='duration_appointments' id='duration_appointments' value=appointmentform.durationAppointments!'' params='onkeypress="return validateQty(event);"' maxlength=3 />
					</@formGroup>
					<@formGroup labelFor='max_capacity_per_slot' labelKey='#i18n{appointment.createAppointmentForm.labelMaxCapacityPerSlot}' helpKey='#i18n{appointment.createAppointmentForm.labelMaxCapacityPerSlot.help}' mandatory=true>
						<@input type='text' name='max_capacity_per_slot' id='max_capacity_per_slot' value=appointmentform.maxCapacityPerSlot!'' params='onkeypress="return validateQty(event);"' maxlength=3 />
					</@formGroup>
					<#if !appointmentform.isMultislotAppointment >
						<@formGroup labelFor='max_people_per_appointment' mandatory=true labelKey='#i18n{appointment.createAppointmentForm.labelMaxPeoplePerAppointment}' helpKey='#i18n{appointment.createAppointmentForm.labelMaxPeoplePerAppointment.help}' mandatory=true>
							<@input type='text' name='max_people_per_appointment' id='max_people_per_appointment' value=appointmentform.maxPeoplePerAppointment!'' params='onkeypress="return validateQty(event);"' maxlength=3 />
						</@formGroup>
					</#if>
				</@fieldSet>
				<@fieldSet legend='#i18n{appointment.createAppointmentForm.labelTitleDaysOpen}'>
					<@formGroup labelFor='is_open_monday'>
						<@checkBox labelFor='is_open_monday' labelKey='#i18n{appointment.label.OpenMonday}' name='is_open_monday' id='is_open_monday' value='true' checked=appointmentform.isOpenMonday!false />
					</@formGroup>
					<@formGroup labelFor='is_open_tuesday'>
						<@checkBox labelFor='is_open_tuesday' labelKey='#i18n{appointment.label.OpenTuesday}' name='is_open_tuesday' id='is_open_tuesday' value='true' checked=appointmentform.isOpenTuesday!false />
					</@formGroup>
					<@formGroup labelFor='is_open_wednesday'>
						<@checkBox labelFor='is_open_wednesday' labelKey='#i18n{appointment.label.OpenWednesday}' name='is_open_wednesday' id='is_open_wednesday' value='true' checked=appointmentform.isOpenWednesday!false />
					</@formGroup>
					<@formGroup labelFor='is_open_thursday'>
						<@checkBox labelFor='is_open_thursday' labelKey='#i18n{appointment.label.OpenThursday}' name='is_open_thursday' id='is_open_thursday' value='true' checked=appointmentform.isOpenThursday!false />
					</@formGroup>
					<@formGroup labelFor='is_open_friday'>
						<@checkBox labelFor='is_open_friday' labelKey='#i18n{appointment.label.OpenFriday}' name='is_open_friday' id='is_open_friday' value='true' checked=appointmentform.isOpenFriday!false />
					</@formGroup>
					<@formGroup labelFor='is_open_saturday'>
						<@checkBox labelFor='is_open_saturday' labelKey='#i18n{appointment.label.OpenSaturday}' name='is_open_saturday' id='is_open_saturday' value='true' checked=appointmentform.isOpenSaturday!false />
					</@formGroup>
					<@formGroup labelFor='is_open_sunday'>
						<@checkBox labelFor='is_open_sunday' labelKey='#i18n{appointment.label.OpenSunday}' name='is_open_sunday' id='is_open_sunday' value='true' checked=appointmentform.isOpenSunday!false />
					</@formGroup>
				</@fieldSet>
				<@fieldSet legend='#i18n{appointment.modifyAppointmentForm.startEditForm}'>
					<@formGroup labelFor='date_of_modification' labelKey='#i18n{appointment.modifyAppointmentForm.startDate}' helpKey='#i18n{appointment.modifyAppointmentForm.helpDateMin}' mandatory=true>
						<@inputGroup>
							<@inputGroupItem type='text'>
								<@icon style='calendar' />
							</@inputGroupItem>
							<@input type='text' name='date_of_modification' id='date_of_modification' value=appointmentform.dateOfModification!'' />
						</@inputGroup>
					</@formGroup>
					<@formGroup>
						<@button type='submit' name='action_modifyAdvancedParameters' title='#i18n{portal.util.labelCreate}' buttonIcon='check' />
						<@button type='submit' name='view_manageAppointmentForms' title='#i18n{portal.util.labelCancel}' buttonIcon='times' cancel=true />
					</@formGroup>
				</@fieldSet>
			</@tform>
			<!-- <hr color="black"> -->
			<div id="calendar" style="margin-top:15px"></div>
		</@appointmentTabs>
    </@columns>
</@row>

<@modal id='commentModal'>
    <@modalHeader modalTitle='#i18n{appointment.create_comment.pageTitle}' />
	<@modalBody>
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<@modal id='modify-comment'>
	<@modalHeader modalTitle='#i18n{appointment.modify_comment.pageTitle}' />
	<@modalBody>
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<@getDatePickerBootstrap idField="date_of_modification" language=language />
<script type="text/javascript">
$('#date_of_modification').datepicker({
        language:        "${language}",
        startDate:         new Date(),
        weekStart: 1,
        todayBtn: true,
        todayHighLight: true,
        autoclose: true
    });
$(function () {
    $('#datetimepicker').datetimepicker({
        format: 'HH:mm',
        stepping: 5
    });
    $('#time_start').datetimepicker({
        format: 'HH:mm',
        stepping: 5
    });
    $('#time_end').datetimepicker({
        format: 'HH:mm',
        stepping: 5
    });
});
function validateQty(event) {
        var key = window.event ? event.keyCode : event.which;
    if (event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 46
     || event.keyCode == 37 || event.keyCode == 39) {
        return true;
    }
    else if ( key < 48 || key > 57 ) {
        return false;
    }
    else return true;
    };
    var slotDuration = '${min_duration}';
    var minTime = '${min_time}';
    var maxTime = '${max_time}';
    var dow = [
        <#if dow??>
            <#list dow as day>
                '${day}',
            </#list>
        </#if>
    ];
    var eventUrl = 'jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp?view=viewModifyTimeSlot&id_form=${appointmentform.idForm}&id_week_definition=${id_week_definition}&id_time_slot=';
    var columnFormat = 'dddd';
    var events = [
        <#if events??>
            <#list events as event>
                {
                    title : 'Capacit\u00e9 max : ' + '${event.maxCapacity}',
                    start : '${event.startingDateTime}',
                    end : '${event.endingDateTime}',
                    id : '${event.idTimeSlot}',
                    color : <#if event.isOpen>'transparent'<#else>'#bebebe'</#if>,
                    textColor: '#2c2c2d',
                    backgroundColor : <#if event.isOpen>'white'<#else>'#bebebe'</#if>,
                    borderColor : '#bebebe',
					
                },
            </#list>
        </#if>
        <#if comment_events??>
            <#list comment_events as comment_event>
            {
                "title" : "${comment_event.comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '\\"')}",
                "start" : "${comment_event.startingValidityDate}",
                "end" : "${comment_event.calendarAllDaySlotEnd}",
                "validity_end" : "${comment_event.endingValidityDate}",
                "id" : "${comment_event.id}",
                "creator_user" : "${comment_event.creatorUserName!''}",
                "creation_date" : "${comment_event.creationDate?date.xs!''}",
                "type": "comment"
            },
            </#list>
        </#if>
    ];
    $( function() {
        $('#calendar').fullCalendar({
            allDaySlot: true,
            displayEventTime: false,
            defaultView: 'agendaWeek',
            height: 'auto',
            locale: 'fr',
            themeSystem: 'jquery-ui',
            editable: false,
            header: false,
            columnFormat: columnFormat,
            slotLabelFormat: 'H:mm',
            slotLabelInterval: slotDuration,
            slotDuration: slotDuration,
            minTime: minTime,
            maxTime: maxTime,
            businessHours: {
                start: minTime,
                end: maxTime,
                dow: dow
            },
            eventClick: function(calEvent, jsEvent, view) {
                location.href = eventUrl + calEvent.id;
            },
            events: events,
            eventMouseover: function ( event, jsEvent, view) {
                var line='',hours=event.start.format('HH'), minutes = parseInt( event.start.format('mm') );
                if( minutes==15 || minutes==45 ){
                    minutes = minutes - 15;
                    line = 'tr[data-time="' + hours + ':' + minutes + ':00"]';
                } else {
                    line = 'tr[data-time="' + event.start.format('HH:mm:ss') + '"]';     
                }
                $(line).children('td').addClass('hover')
            },
            eventMouseout: function ( event, jsEvent, view) {
                var line='',hours=event.start.format('HH'), minutes = parseInt( event.start.format('mm') );
                if( minutes==15 || minutes==45 ){
                    minutes = minutes - 15;
                    console.log( minutes );
                    line = 'tr[data-time="' + hours + ':' + minutes + ':00"]';
                } else {
                    line = 'tr[data-time="' + event.start.format('HH:mm:ss') + '"]';     
                }
                $(line).children('td').removeClass('hover')
            },
            eventRender: function(event, element) {
                var $title = element.find( '.fc-title' );
                $(element).addClass( event.customClass );
                
                if ( event.customStyle !='' ){
                    $(element).css( 'background', event.customStyle );
                }
                
                $title.html( $title.text() );
                
                $(element).contextmenu(function() {
                    return false;
                });

                var json = {
                    "container": "body",
                    "placement" : "bottom",
                    "html" : true,
                    "trigger" : "hover"
                };

                if( event.type == "comment" ){
                    if ( event.validity_end == null || event.validity_end == undefined ){
                        labelEventDate='Le ' + event.start.format('ddd DD/MM');
                    } else {
                        moment.locale("fr");
                        labelEventDate = 'Du ' + event.start.format('ddd DD/MM') + ' au '+ moment(event.validity_end).format('ddd DD/MM');
                    }
                    json.content = '<p>' + labelEventDate +'<p><hr>'+ event.title + '<hr><p><strong>Par ' + event.creator_user + '</strong> le <time>' + event.creation_date + '</time>' ;
                } else {
                    json.content = event.start.format('ddd DD/MM')+"</center>" + "<center><b>" + event.start.format('HH:mm') + "</b> - <b>" + event.end.format('HH:mm')+"</b></center>";
                }

                $(element).popover( json );
                
                if(event.type == "comment" ){
                    var fcTitle = element.find('.fc-title p');
                    fcTitle.prepend( '[' + event.creator_user + ' | ' + event.creation_date + '] ');
                    element.append( "<div class='btn-comments'><a href='' class='toggle-modify-comment' data-json='{\"id_comment\": \"" + event.id + "\", \"comment_text\": \"" + event.title.replace(/"/g,'\\"') + "\", \"comment_start\":\"" + event.start.format('YYYY-MM-DD') + "\", \"comment_end\":\"" + event.validity_end + "\" }' ><i class='fa fa-pencil fa-fw'></i></a><a href='jsp/admin/plugins/appointment/Comments.jsp?action=confirmRemoveComment&id_comment=" + event.id + "' class='closeon text-danger'><i class='fa fa-remove fa-fw'></i></a></div>" );
                }
            },
            eventAfterAllRender: function(view) {
                $('.fc-event').css('cursor', 'pointer');
                $(".fc-view.fc-agendaWeek-view.fc-agenda-view .fc-body .ui-widget-content .fc-day-grid .fc-bg .fc-axis.ui-widget-content").html( '' );
                
                $('.toggle-modify-comment').click(function(ev) {
                    ev.preventDefault();
                    var formValues = JSON.parse( $(this).attr( "data-json" ) );
                    $("#modify-comment input[name='id_comment']").val( formValues.id_comment );
                    tinyMCE.activeEditor.setContent( formValues.comment_text );
                    $( "#modify-comment input[name='startingValidityDate']" ).datepicker().datepicker( 'setDate', new Date( formValues.comment_start ) );
                    $( "#modify-comment input[name='endingValidityDate']" ).datepicker().datepicker( 'setDate', new Date( formValues.comment_end ) );
                    $( "#modify-comment" ).modal('show');
                });
                
                /* Event selection          */ 
                var eventIdx=0, eventData='';
                
                $( ".fc-content-skeleton" ).selectable({
                    filter: ".fc-time-grid-event.fc-v-event",
                    selecting: function( event, ui ) {
                        eventIdx++;
                    },
                    unselecting: function( event, ui ) {
                        eventIdx--;
                    },
                    stop: function() {
                        console.log(  eventIdx  );   
                        $( ".ui-selected", this ).each( function() {
                            console.log( eventData );
                            if ( eventIdx > 1 ){
                                eventData += '{' + $(this).data('event') + '};' ;
                                const events =  JSON.stringify( eventData );
                                $('#slotsData').val( '[' + events + ']' );
                                $('#updatePlanningMultiSlot').modal('show');
                                
                            } else {
                                eventData ='{' + $(this).data('event') + '}';                       
                                const evt = JSON.parse(eventData); 
                                const idSlot = JSON.parse( evt.slotId );
                        
                                location.href = eventUrl + idSlot;
                            }
                        
                        });
                        eventData='';
                    }
                });
            },
        });
		
    });
</script>